<!DOCTYPE html>
{% load app_filters %}
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>SpeakInOut {% block title %}{% endblock %}</title>

    <link rel="stylesheet" href="{% static 'videojs-npm/node_modules/video.js/dist/video-js.min.css' %}">
    <link rel="stylesheet" href="{% static 'videojs-npm/dist/css/videojs.record.css' %}">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="{% static 'videojs-npm/node_modules/video.js/dist/video.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'videojs-npm/node_modules/recordrtc/RecordRTC.js' %}"></script>
    <script type="text/javascript" src="{% static 'videojs-npm/node_modules/webrtc-adapter/out/adapter.js' %}"></script>
    <script type="text/javascript" src="{% static 'videojs-npm/dist/videojs.record.js' %}"></script>
    <script type="text/javascript" src="{% static 'videojs-npm/browser-workarounds.js' %}"></script>
</head>
<body>
    {% block body %}

    {% endblock %}

    {% if dashboard %}
    <video id="myVideo" playsinline class="video-js vjs-default-skin"></video>
    <button class="audio-btn strt disable-btn" id="submit" disabled>Submit</button>
    <span class="upload-comp">Uploading Complete</span>
    <script>
    $(document).ready(function(){
        var options = {
            controls: true,
            width: 320,
            height: 240,
            fluid: false,
            plugins: {
                record: {
                    audio: true,
                    video: true,
                    maxLength: 20,
                    debug: true
                }
            }
        };

        // apply some workarounds for opera browser
        applyVideoWorkaround();

        var player = videojs('myVideo', options, function() {
            // print version information at startup
            var msg = 'Using video.js ' + videojs.VERSION +
                ' with videojs-record ' + videojs.getPluginVersion('record') +
                ' and recordrtc ' + RecordRTC.version;
            videojs.log(msg);
        });

        // error handling
        player.on('deviceError', function() {
            console.log('device error:', player.deviceErrorCode);
        });

        player.on('error', function(element, error) {
            console.error(error);
        });

        // user clicked the record button and started recording
        player.on('startRecord', function() {
            console.log('started recording!');
        });

        // user completed recording and stream is available
        player.on('finishRecord', function() {
            // the blob object contains the recorded data that
            // can be downloaded by the user, stored on server etc.
            console.log('finished recording: ', player.recordedData);
            $('#submit').prop('disabled', false);
            $('#submit').removeClass('disable-btn');
        });

        $('#submit').on('click', function(){
            var btn = $(this);
            btn.html('Saving...').prop('disabled', true).addClass('disable-btn');
            var myFile = new File([player.recordedData], 'audio.webm');
            var csrf = $('input[name="csrfmiddlewaretoken"]').val();
            var url = "{% url 'auth:dashboard' %}";
            var data = new FormData();
            data.append('recorded_audio', myFile);
            data.append('csrfmiddlewaretoken', csrf);
            console.log("Data: " + data);
            $.ajax({
                url: url,
                method: 'post',
                headers: { "X-CSRFToken": csrf },
                data: data,
                success: function(data){
                    if(data.success){
                        btn.html('Re Submit');
                        $('.upload-comp').show();
                    }
                    else{
                        btn.html('Error').prop('disabled', false).removeClass('disable-btn');
                    }
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
    });
    </script>
    {% endif %}
</body>
</html>